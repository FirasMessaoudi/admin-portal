/*
 * Copyright (c) 2019 ELM. All rights reserved.
 */
import { __decorate, __metadata, __param } from "tslib";
import { Inject, Injectable, Optional } from '@angular/core';
import { HttpResponse } from '@angular/common/http';
import { timer } from 'rxjs';
import { map } from 'rxjs/operators';
import { CookieService } from "ngx-cookie-service";
import { Router } from "@angular/router";
import { Logger } from "../logging";
var TOKEN_EXPIRY_COOKIE_NAME = 'X-SEC-TK-EXP';
var TOKEN_COOKIE_NAME = 'X-SEC-TK';
var CONTENT_TYPE_HEADER_NAME = 'Content-Type';
var USER_STORAGE_ITEM_KEY = 'currentUser';
var log = new Logger('Login');
export var PUBLIC_URL_PATTERNS = 'PUBLIC_URL_PATTERNS';
export var LOGIN_URL = 'LOGIN_URL';
var JwtInterceptor = /** @class */ (function () {
    function JwtInterceptor(cookieService, router, environment, publicUrlPatterns, loginUrl) {
        if (publicUrlPatterns === void 0) { publicUrlPatterns = []; }
        if (loginUrl === void 0) { loginUrl = '/login.html'; }
        this.cookieService = cookieService;
        this.router = router;
        this.environment = environment;
        this.publicUrlPatterns = publicUrlPatterns;
        this.loginUrl = loginUrl;
        this.tokenExpiryDateTimerSubscription = null;
    }
    JwtInterceptor.prototype.intercept = function (request, next) {
        var _this = this;
        var headers = request.headers;
        if (request.headers.get(CONTENT_TYPE_HEADER_NAME) == null) {
            headers = request.headers.append(CONTENT_TYPE_HEADER_NAME, 'application/json');
        }
        else if (request.headers.get(CONTENT_TYPE_HEADER_NAME).startsWith("multipart/form-data")) {
            headers = request.headers.delete(CONTENT_TYPE_HEADER_NAME);
        }
        var currentUser = JSON.parse(localStorage.getItem(USER_STORAGE_ITEM_KEY));
        if (currentUser && this.tokenExpiryDateTimerSubscription == null) {
            this.refreshTokenTimer();
        }
        request = request.clone({ headers: headers });
        var started = Date.now();
        return next.handle(request).pipe(map(function (event) {
            if (event instanceof HttpResponse) {
                if (!_this.environment.production) {
                    var elapsed = Date.now() - started;
                    console.log("Request for " + request.urlWithParams + " took " + elapsed + " ms.");
                }
                if (_this.cookieService.get(TOKEN_EXPIRY_COOKIE_NAME)) {
                    console.log("found " + TOKEN_EXPIRY_COOKIE_NAME + " with value [" + _this.cookieService.get(TOKEN_EXPIRY_COOKIE_NAME) + "]");
                    if (_this.tokenExpiryDateTimerSubscription) {
                        _this.tokenExpiryDateTimerSubscription.unsubscribe();
                        _this.refreshTokenTimer();
                    }
                }
            }
            return event;
        }));
    };
    JwtInterceptor.prototype.refreshTokenTimer = function () {
        var _this = this;
        var isPublicUrl = false;
        this.publicUrlPatterns.forEach(function (urlPattern) {
            isPublicUrl = isPublicUrl || _this.router.url.startsWith(urlPattern);
        });
        if (isPublicUrl && !this.router.url.startsWith(this.loginUrl)) {
            // do nothing
            log.debug('skipping public url...');
            return;
        }
        log.debug('secured url, setting timer...');
        var tokenExpiry = this.cookieService.get(TOKEN_EXPIRY_COOKIE_NAME);
        this.tokenExpiryDateTimerSubscription = timer(tokenExpiry).subscribe(function () {
            localStorage.removeItem(USER_STORAGE_ITEM_KEY);
            _this.cookieService.delete(TOKEN_EXPIRY_COOKIE_NAME);
            _this.cookieService.delete(TOKEN_COOKIE_NAME);
            _this.router.navigate([_this.loginUrl], { replaceUrl: true });
        });
    };
    JwtInterceptor.ctorParameters = function () { return [
        { type: CookieService },
        { type: Router },
        { type: undefined, decorators: [{ type: Inject, args: ['environment',] }] },
        { type: Array, decorators: [{ type: Optional }, { type: Inject, args: [PUBLIC_URL_PATTERNS,] }] },
        { type: String, decorators: [{ type: Optional }, { type: Inject, args: [LOGIN_URL,] }] }
    ]; };
    JwtInterceptor = __decorate([
        Injectable(),
        __param(2, Inject('environment')),
        __param(3, Optional()), __param(3, Inject(PUBLIC_URL_PATTERNS)),
        __param(4, Optional()), __param(4, Inject(LOGIN_URL)),
        __metadata("design:paramtypes", [CookieService, Router, Object, Array, String])
    ], JwtInterceptor);
    return JwtInterceptor;
}());
export { JwtInterceptor };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiand0LmludGVyY2VwdG9yLmpzIiwic291cmNlUm9vdCI6Im5nOi8vQGRjYy1jb21tb25zLW5nL3NlcnZpY2VzLyIsInNvdXJjZXMiOlsibGliL2h0dHAvand0LmludGVyY2VwdG9yLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBOztHQUVHOztBQUVILE9BQU8sRUFBQyxNQUFNLEVBQUUsVUFBVSxFQUFFLFFBQVEsRUFBQyxNQUFNLGVBQWUsQ0FBQztBQUMzRCxPQUFPLEVBQW9FLFlBQVksRUFBQyxNQUFNLHNCQUFzQixDQUFDO0FBQ3JILE9BQU8sRUFBYSxLQUFLLEVBQUMsTUFBTSxNQUFNLENBQUM7QUFDdkMsT0FBTyxFQUFDLEdBQUcsRUFBQyxNQUFNLGdCQUFnQixDQUFDO0FBQ25DLE9BQU8sRUFBQyxhQUFhLEVBQUMsTUFBTSxvQkFBb0IsQ0FBQztBQUNqRCxPQUFPLEVBQUMsTUFBTSxFQUFDLE1BQU0saUJBQWlCLENBQUM7QUFDdkMsT0FBTyxFQUFDLE1BQU0sRUFBQyxNQUFNLFlBQVksQ0FBQztBQUVsQyxJQUFNLHdCQUF3QixHQUFHLGNBQWMsQ0FBQztBQUNoRCxJQUFNLGlCQUFpQixHQUFHLFVBQVUsQ0FBQztBQUNyQyxJQUFNLHdCQUF3QixHQUFHLGNBQWMsQ0FBQztBQUNoRCxJQUFNLHFCQUFxQixHQUFHLGFBQWEsQ0FBQztBQUU1QyxJQUFNLEdBQUcsR0FBRyxJQUFJLE1BQU0sQ0FBQyxPQUFPLENBQUMsQ0FBQztBQUVoQyxNQUFNLENBQUMsSUFBTSxtQkFBbUIsR0FBVyxxQkFBcUIsQ0FBQztBQUNqRSxNQUFNLENBQUMsSUFBTSxTQUFTLEdBQVcsV0FBVyxDQUFDO0FBRzdDO0lBSUUsd0JBQW9CLGFBQTRCLEVBQVUsTUFBYyxFQUFpQyxXQUFnQixFQUM1RCxpQkFBcUMsRUFDL0MsUUFBZ0M7UUFEdEIsa0NBQUEsRUFBQSxzQkFBcUM7UUFDL0MseUJBQUEsRUFBQSx3QkFBZ0M7UUFGL0Qsa0JBQWEsR0FBYixhQUFhLENBQWU7UUFBVSxX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dGVudCI6WyIvKlxuICogQ29weXJpZ2h0IChjKSAyMDE5IEVMTS4gQWxsIHJpZ2h0cyByZXNlcnZlZC5cbiAqL1xuXG5pbXBvcnQge0luamVjdCwgSW5qZWN0YWJsZSwgT3B0aW9uYWx9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xuaW1wb3J0IHtIdHRwRXZlbnQsIEh0dHBIYW5kbGVyLCBIdHRwSGVhZGVycywgSHR0cEludGVyY2VwdG9yLCBIdHRwUmVxdWVzdCwgSHR0cFJlc3BvbnNlfSBmcm9tICdAYW5ndWxhci9jb21tb24vaHR0cCc7XG5pbXBvcnQge09ic2VydmFibGUsIHRpbWVyfSBmcm9tICdyeGpzJztcbmltcG9ydCB7bWFwfSBmcm9tICdyeGpzL29wZXJhdG9ycyc7XG5pbXBvcnQge0Nvb2tpZVNlcnZpY2V9IGZyb20gXCJuZ3gtY29va2llLXNlcnZpY2VcIjtcbmltcG9ydCB7Um91dGVyfSBmcm9tIFwiQGFuZ3VsYXIvcm91dGVyXCI7XG5pbXBvcnQge0xvZ2dlcn0gZnJvbSBcIi4uL2xvZ2dpbmdcIjtcblxuY29uc3QgVE9LRU5fRVhQSVJZX0NPT0tJRV9OQU1FID0gJ1gtU0VDLVRLLUVYUCc7XG5jb25zdCBUT0tFTl9DT09LSUVfTkFNRSA9ICdYLVNFQy1USyc7XG5jb25zdCBDT05URU5UX1RZUEVfSEVBREVSX05BTUUgPSAnQ29udGVudC1UeXBlJztcbmNvbnN0IFVTRVJfU1RPUkFHRV9JVEVNX0tFWSA9ICdjdXJyZW50VXNlcic7XG5cbmNvbnN0IGxvZyA9IG5ldyBMb2dnZXIoJ0xvZ2luJyk7XG5cbmV4cG9ydCBjb25zdCBQVUJMSUNfVVJMX1BBVFRFUk5TOiBzdHJpbmcgPSAnUFVCTElDX1VSTF9QQVRURVJOUyc7XG5leHBvcnQgY29uc3QgTE9HSU5fVVJMOiBzdHJpbmcgPSAnTE9HSU5fVVJMJztcblxuQEluamVjdGFibGUoKVxuZXhwb3J0IGNsYXNzIEp3dEludGVyY2VwdG9yIGltcGxlbWVudHMgSHR0cEludGVyY2VwdG9yIHtcblxuICBwdWJsaWMgdG9rZW5FeHBpcnlEYXRlVGltZXJTdWJzY3JpcHRpb246IGFueSA9IG51bGw7XG5cbiAgY29uc3RydWN0b3IocHJpdmF0ZSBjb29raWVTZXJ2aWNlOiBDb29raWVTZXJ2aWNlLCBwcml2YXRlIHJvdXRlcjogUm91dGVyLCBASW5qZWN0KCdlbnZpcm9ubWVudCcpIHByaXZhdGUgZW52aXJvbm1lbnQ6IGFueSxcbiAgICAgICAgICAgICAgQE9wdGlvbmFsKCkgQEluamVjdChQVUJMSUNfVVJMX1BBVFRFUk5TKSBwcml2YXRlIHB1YmxpY1VybFBhdHRlcm5zOiBBcnJheTxTdHJpbmc+ID0gW10sXG4gICAgICAgICAgICAgIEBPcHRpb25hbCgpIEBJbmplY3QoTE9HSU5fVVJMKSBwcml2YXRlIGxvZ2luVXJsOiBzdHJpbmcgPSAnL2xvZ2luLmh0bWwnKSB7XG4gIH1cblxuICBpbnRlcmNlcHQocmVxdWVzdDogSHR0cFJlcXVlc3Q8YW55PiwgbmV4dDogSHR0cEhhbmRsZXIpOiBPYnNlcnZhYmxlPEh0dHBFdmVudDxhbnk+PiB7XG4gICAgbGV0IGhlYWRlcnM6IEh0dHBIZWFkZXJzID0gcmVxdWVzdC5oZWFkZXJzO1xuICAgIGlmIChyZXF1ZXN0LmhlYWRlcnMuZ2V0KENPTlRFTlRfVFlQRV9IRUFERVJfTkFNRSkgPT0gbnVsbCkge1xuICAgICAgaGVhZGVycyA9IHJlcXVlc3QuaGVhZGVycy5hcHBlbmQoQ09OVEVOVF9UWVBFX0hFQURFUl9OQU1FLCAnYXBwbGljYXRpb24vanNvbicpO1xuICAgIH0gZWxzZSBpZiAocmVxdWVzdC5oZWFkZXJzLmdldChDT05URU5UX1RZUEVfSEVBREVSX05BTUUpLnN0YXJ0c1dpdGgoXCJtdWx0aXBhcnQvZm9ybS1kYXRhXCIpKSB7XG4gICAgICBoZWFkZXJzID0gcmVxdWVzdC5oZWFkZXJzLmRlbGV0ZShDT05URU5UX1RZUEVfSEVBREVSX05BTUUpO1xuICAgIH1cblxuICAgIGxldCBjdXJyZW50VXNlciA9IEpTT04ucGFyc2UobG9jYWxTdG9yYWdlLmdldEl0ZW0oVVNFUl9TVE9SQUdFX0lURU1fS0VZKSk7XG4gICAgaWYgKGN1cnJlbnRVc2VyICYmIHRoaXMudG9rZW5FeHBpcnlEYXRlVGltZXJTdWJzY3JpcHRpb24gPT0gbnVsbCkge1xuICAgICAgdGhpcy5yZWZyZXNoVG9rZW5UaW1lcigpO1xuICAgIH1cblxuICAgIHJlcXVlc3QgPSByZXF1ZXN0LmNsb25lKHtoZWFkZXJzfSk7XG5cbiAgICBjb25zdCBzdGFydGVkID0gRGF0ZS5ub3coKTtcbiAgICByZXR1cm4gbmV4dC5oYW5kbGUocmVxdWVzdCkucGlwZShcbiAgICAgIG1hcChldmVudCA9PiB7XG4gICAgICAgIGlmIChldmVudCBpbnN0YW5jZW9mIEh0dHBSZXNwb25zZSkge1xuICAgICAgICAgIGlmICghdGhpcy5lbnZpcm9ubWVudC5wcm9kdWN0aW9uKSB7XG4gICAgICAgICAgICBjb25zdCBlbGFwc2VkID0gRGF0ZS5ub3coKSAtIHN0YXJ0ZWQ7XG4gICAgICAgICAgICBjb25zb2xlLmxvZyhgUmVxdWVzdCBmb3IgJHtyZXF1ZXN0LnVybFdpdGhQYXJhbXN9IHRvb2sgJHtlbGFwc2VkfSBtcy5gKTtcbiAgICAgICAgICB9XG4gICAgICAgICAgaWYgKHRoaXMuY29va2llU2VydmljZS5nZXQoVE9LRU5fRVhQSVJZX0NPT0tJRV9OQU1FKSkge1xuICAgICAgICAgICAgY29uc29sZS5sb2coYGZvdW5kICR7VE9LRU5fRVhQSVJZX0NPT0tJRV9OQU1FfSB3aXRoIHZhbHVlIFske3RoaXMuY29va2llU2VydmljZS5nZXQoVE9LRU5fRVhQSVJZX0NPT0tJRV9OQU1FKX1dYCk7XG4gICAgICAgICAgICBpZiAodGhpcy50b2tlbkV4cGlyeURhdGVUaW1lclN1YnNjcmlwdGlvbikge1xuICAgICAgICAgICAgICB0aGlzLnRva2VuRXhwaXJ5RGF0ZVRpbWVyU3Vic2NyaXB0aW9uLnVuc3Vic2NyaWJlKCk7XG4gICAgICAgICAgICAgIHRoaXMucmVmcmVzaFRva2VuVGltZXIoKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIGV2ZW50O1xuICAgICAgfSlcbiAgICApO1xuICB9XG5cbiAgcmVmcmVzaFRva2VuVGltZXIoKSB7XG4gICAgbGV0IGlzUHVibGljVXJsOiBib29sZWFuID0gZmFsc2U7XG4gICAgdGhpcy5wdWJsaWNVcmxQYXR0ZXJucy5mb3JFYWNoKCh1cmxQYXR0ZXJuOiBzdHJpbmcpID0+IHtcbiAgICAgIGlzUHVibGljVXJsID0gaXNQdWJsaWNVcmwgfHwgdGhpcy5yb3V0ZXIudXJsLnN0YXJ0c1dpdGgodXJsUGF0dGVybik7XG4gICAgfSk7XG4gICAgaWYgKGlzUHVibGljVXJsICYmICF0aGlzLnJvdXRlci51cmwuc3RhcnRzV2l0aCh0aGlzLmxvZ2luVXJsKSkge1xuICAgICAgLy8gZG8gbm90aGluZ1xuICAgICAgbG9nLmRlYnVnKCdza2lwcGluZyBwdWJsaWMgdXJsLi4uJyk7XG4gICAgICByZXR1cm47XG4gICAgfVxuICAgIGxvZy5kZWJ1Zygnc2VjdXJlZCB1cmwsIHNldHRpbmcgdGltZXIuLi4nKTtcbiAgICBsZXQgdG9rZW5FeHBpcnk6IHVua25vd24gPSB0aGlzLmNvb2tpZVNlcnZpY2UuZ2V0KFRPS0VOX0VYUElSWV9DT09LSUVfTkFNRSk7XG4gICAgdGhpcy50b2tlbkV4cGlyeURhdGVUaW1lclN1YnNjcmlwdGlvbiA9IHRpbWVyKHRva2VuRXhwaXJ5IGFzIG51bWJlcikuc3Vic2NyaWJlKCgpID0+IHtcbiAgICAgIGxvY2FsU3RvcmFnZS5yZW1vdmVJdGVtKFVTRVJfU1RPUkFHRV9JVEVNX0tFWSk7XG4gICAgICB0aGlzLmNvb2tpZVNlcnZpY2UuZGVsZXRlKFRPS0VOX0VYUElSWV9DT09LSUVfTkFNRSk7XG4gICAgICB0aGlzLmNvb2tpZVNlcnZpY2UuZGVsZXRlKFRPS0VOX0NPT0tJRV9OQU1FKTtcbiAgICAgIHRoaXMucm91dGVyLm5hdmlnYXRlKFt0aGlzLmxvZ2luVXJsXSwge3JlcGxhY2VVcmw6IHRydWV9KTtcbiAgICB9KTtcbiAgfVxufVxuIl19