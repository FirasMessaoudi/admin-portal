/*
 * Copyright (c) 2019 ELM. All rights reserved.
 */
import { __decorate, __metadata, __param } from "tslib";
import { Inject, Injectable, Optional } from '@angular/core';
import { HttpResponse } from '@angular/common/http';
import { timer } from 'rxjs';
import { map } from 'rxjs/operators';
import { CookieService } from "ngx-cookie-service";
import { Router } from "@angular/router";
import { Logger } from "../logging";
const TOKEN_EXPIRY_COOKIE_NAME = 'X-SEC-TK-EXP';
const TOKEN_COOKIE_NAME = 'X-SEC-TK';
const CONTENT_TYPE_HEADER_NAME = 'Content-Type';
const USER_STORAGE_ITEM_KEY = 'currentUser';
const log = new Logger('Login');
export const PUBLIC_URL_PATTERNS = 'PUBLIC_URL_PATTERNS';
export const LOGIN_URL = 'LOGIN_URL';
let JwtInterceptor = class JwtInterceptor {
    constructor(cookieService, router, environment, publicUrlPatterns = [], loginUrl = '/login.html') {
        this.cookieService = cookieService;
        this.router = router;
        this.environment = environment;
        this.publicUrlPatterns = publicUrlPatterns;
        this.loginUrl = loginUrl;
        this.tokenExpiryDateTimerSubscription = null;
    }
    intercept(request, next) {
        let headers = request.headers;
        if (request.headers.get(CONTENT_TYPE_HEADER_NAME) == null) {
            headers = request.headers.append(CONTENT_TYPE_HEADER_NAME, 'application/json');
        }
        else if (request.headers.get(CONTENT_TYPE_HEADER_NAME).startsWith("multipart/form-data")) {
            headers = request.headers.delete(CONTENT_TYPE_HEADER_NAME);
        }
        let currentUser = JSON.parse(localStorage.getItem(USER_STORAGE_ITEM_KEY));
        if (currentUser && this.tokenExpiryDateTimerSubscription == null) {
            this.refreshTokenTimer();
        }
        request = request.clone({ headers });
        const started = Date.now();
        return next.handle(request).pipe(map(event => {
            if (event instanceof HttpResponse) {
                if (!this.environment.production) {
                    const elapsed = Date.now() - started;
                    console.log(`Request for ${request.urlWithParams} took ${elapsed} ms.`);
                }
                if (this.cookieService.get(TOKEN_EXPIRY_COOKIE_NAME)) {
                    console.log(`found ${TOKEN_EXPIRY_COOKIE_NAME} with value [${this.cookieService.get(TOKEN_EXPIRY_COOKIE_NAME)}]`);
                    if (this.tokenExpiryDateTimerSubscription) {
                        this.tokenExpiryDateTimerSubscription.unsubscribe();
                        this.refreshTokenTimer();
                    }
                }
            }
            return event;
        }));
    }
    refreshTokenTimer() {
        let isPublicUrl = false;
        this.publicUrlPatterns.forEach((urlPattern) => {
            isPublicUrl = isPublicUrl || this.router.url.startsWith(urlPattern);
        });
        if (isPublicUrl && !this.router.url.startsWith(this.loginUrl)) {
            // do nothing
            log.debug('skipping public url...');
            return;
        }
        log.debug('secured url, setting timer...');
        let tokenExpiry = this.cookieService.get(TOKEN_EXPIRY_COOKIE_NAME);
        this.tokenExpiryDateTimerSubscription = timer(tokenExpiry).subscribe(() => {
            localStorage.removeItem(USER_STORAGE_ITEM_KEY);
            this.cookieService.delete(TOKEN_EXPIRY_COOKIE_NAME);
            this.cookieService.delete(TOKEN_COOKIE_NAME);
            this.router.navigate([this.loginUrl], { replaceUrl: true });
        });
    }
};
JwtInterceptor.ctorParameters = () => [
    { type: CookieService },
    { type: Router },
    { type: undefined, decorators: [{ type: Inject, args: ['environment',] }] },
    { type: Array, decorators: [{ type: Optional }, { type: Inject, args: [PUBLIC_URL_PATTERNS,] }] },
    { type: String, decorators: [{ type: Optional }, { type: Inject, args: [LOGIN_URL,] }] }
];
JwtInterceptor = __decorate([
    Injectable(),
    __param(2, Inject('environment')),
    __param(3, Optional()), __param(3, Inject(PUBLIC_URL_PATTERNS)),
    __param(4, Optional()), __param(4, Inject(LOGIN_URL)),
    __metadata("design:paramtypes", [CookieService, Router, Object, Array, String])
], JwtInterceptor);
export { JwtInterceptor };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiand0LmludGVyY2VwdG9yLmpzIiwic291cmNlUm9vdCI6Im5nOi8vQGRjYy1jb21tb25zLW5nL3NlcnZpY2VzLyIsInNvdXJjZXMiOlsibGliL2h0dHAvand0LmludGVyY2VwdG9yLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBOztHQUVHOztBQUVILE9BQU8sRUFBQyxNQUFNLEVBQUUsVUFBVSxFQUFFLFFBQVEsRUFBQyxNQUFNLGVBQWUsQ0FBQztBQUMzRCxPQUFPLEVBQW9FLFlBQVksRUFBQyxNQUFNLHNCQUFzQixDQUFDO0FBQ3JILE9BQU8sRUFBYSxLQUFLLEVBQUMsTUFBTSxNQUFNLENBQUM7QUFDdkMsT0FBTyxFQUFDLEdBQUcsRUFBQyxNQUFNLGdCQUFnQixDQUFDO0FBQ25DLE9BQU8sRUFBQyxhQUFhLEVBQUMsTUFBTSxvQkFBb0IsQ0FBQztBQUNqRCxPQUFPLEVBQUMsTUFBTSxFQUFDLE1BQU0saUJBQWlCLENBQUM7QUFDdkMsT0FBTyxFQUFDLE1BQU0sRUFBQyxNQUFNLFlBQVksQ0FBQztBQUVsQyxNQUFNLHdCQUF3QixHQUFHLGNBQWMsQ0FBQztBQUNoRCxNQUFNLGlCQUFpQixHQUFHLFVBQVUsQ0FBQztBQUNyQyxNQUFNLHdCQUF3QixHQUFHLGNBQWMsQ0FBQztBQUNoRCxNQUFNLHFCQUFxQixHQUFHLGFBQWEsQ0FBQztBQUU1QyxNQUFNLEdBQUcsR0FBRyxJQUFJLE1BQU0sQ0FBQyxPQUFPLENBQUMsQ0FBQztBQUVoQyxNQUFNLENBQUMsTUFBTSxtQkFBbUIsR0FBVyxxQkFBcUIsQ0FBQztBQUNqRSxNQUFNLENBQUMsTUFBTSxTQUFTLEdBQVcsV0FBVyxDQUFDO0FBRzdDLElBQWEsY0FBYyxHQUEzQixNQUFhLGNBQWM7SUFJekIsWUFBb0IsYUFBNEIsRUFBVSxNQUFjLEVBQWlDLFdBQWdCLEVBQzVELG9CQUFtQyxFQUFFLEVBQy9DLFdBQW1CLGFBQWE7UUFGL0Qsa0JBQWEsR0FBYixhQUFhLENBQWU7UUFBVSxXQUFNLEdBQU4sTUFB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c2VydmVkLlxuICovXG5cbmltcG9ydCB7SW5qZWN0LCBJbmplY3RhYmxlLCBPcHRpb25hbH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XG5pbXBvcnQge0h0dHBFdmVudCwgSHR0cEhhbmRsZXIsIEh0dHBIZWFkZXJzLCBIdHRwSW50ZXJjZXB0b3IsIEh0dHBSZXF1ZXN0LCBIdHRwUmVzcG9uc2V9IGZyb20gJ0Bhbmd1bGFyL2NvbW1vbi9odHRwJztcbmltcG9ydCB7T2JzZXJ2YWJsZSwgdGltZXJ9IGZyb20gJ3J4anMnO1xuaW1wb3J0IHttYXB9IGZyb20gJ3J4anMvb3BlcmF0b3JzJztcbmltcG9ydCB7Q29va2llU2VydmljZX0gZnJvbSBcIm5neC1jb29raWUtc2VydmljZVwiO1xuaW1wb3J0IHtSb3V0ZXJ9IGZyb20gXCJAYW5ndWxhci9yb3V0ZXJcIjtcbmltcG9ydCB7TG9nZ2VyfSBmcm9tIFwiLi4vbG9nZ2luZ1wiO1xuXG5jb25zdCBUT0tFTl9FWFBJUllfQ09PS0lFX05BTUUgPSAnWC1TRUMtVEstRVhQJztcbmNvbnN0IFRPS0VOX0NPT0tJRV9OQU1FID0gJ1gtU0VDLVRLJztcbmNvbnN0IENPTlRFTlRfVFlQRV9IRUFERVJfTkFNRSA9ICdDb250ZW50LVR5cGUnO1xuY29uc3QgVVNFUl9TVE9SQUdFX0lURU1fS0VZID0gJ2N1cnJlbnRVc2VyJztcblxuY29uc3QgbG9nID0gbmV3IExvZ2dlcignTG9naW4nKTtcblxuZXhwb3J0IGNvbnN0IFBVQkxJQ19VUkxfUEFUVEVSTlM6IHN0cmluZyA9ICdQVUJMSUNfVVJMX1BBVFRFUk5TJztcbmV4cG9ydCBjb25zdCBMT0dJTl9VUkw6IHN0cmluZyA9ICdMT0dJTl9VUkwnO1xuXG5ASW5qZWN0YWJsZSgpXG5leHBvcnQgY2xhc3MgSnd0SW50ZXJjZXB0b3IgaW1wbGVtZW50cyBIdHRwSW50ZXJjZXB0b3Ige1xuXG4gIHB1YmxpYyB0b2tlbkV4cGlyeURhdGVUaW1lclN1YnNjcmlwdGlvbjogYW55ID0gbnVsbDtcblxuICBjb25zdHJ1Y3Rvcihwcml2YXRlIGNvb2tpZVNlcnZpY2U6IENvb2tpZVNlcnZpY2UsIHByaXZhdGUgcm91dGVyOiBSb3V0ZXIsIEBJbmplY3QoJ2Vudmlyb25tZW50JykgcHJpdmF0ZSBlbnZpcm9ubWVudDogYW55LFxuICAgICAgICAgICAgICBAT3B0aW9uYWwoKSBASW5qZWN0KFBVQkxJQ19VUkxfUEFUVEVSTlMpIHByaXZhdGUgcHVibGljVXJsUGF0dGVybnM6IEFycmF5PFN0cmluZz4gPSBbXSxcbiAgICAgICAgICAgICAgQE9wdGlvbmFsKCkgQEluamVjdChMT0dJTl9VUkwpIHByaXZhdGUgbG9naW5Vcmw6IHN0cmluZyA9ICcvbG9naW4uaHRtbCcpIHtcbiAgfVxuXG4gIGludGVyY2VwdChyZXF1ZXN0OiBIdHRwUmVxdWVzdDxhbnk+LCBuZXh0OiBIdHRwSGFuZGxlcik6IE9ic2VydmFibGU8SHR0cEV2ZW50PGFueT4+IHtcbiAgICBsZXQgaGVhZGVyczogSHR0cEhlYWRlcnMgPSByZXF1ZXN0LmhlYWRlcnM7XG4gICAgaWYgKHJlcXVlc3QuaGVhZGVycy5nZXQoQ09OVEVOVF9UWVBFX0hFQURFUl9OQU1FKSA9PSBudWxsKSB7XG4gICAgICBoZWFkZXJzID0gcmVxdWVzdC5oZWFkZXJzLmFwcGVuZChDT05URU5UX1RZUEVfSEVBREVSX05BTUUsICdhcHBsaWNhdGlvbi9qc29uJyk7XG4gICAgfSBlbHNlIGlmIChyZXF1ZXN0LmhlYWRlcnMuZ2V0KENPTlRFTlRfVFlQRV9IRUFERVJfTkFNRSkuc3RhcnRzV2l0aChcIm11bHRpcGFydC9mb3JtLWRhdGFcIikpIHtcbiAgICAgIGhlYWRlcnMgPSByZXF1ZXN0LmhlYWRlcnMuZGVsZXRlKENPTlRFTlRfVFlQRV9IRUFERVJfTkFNRSk7XG4gICAgfVxuXG4gICAgbGV0IGN1cnJlbnRVc2VyID0gSlNPTi5wYXJzZShsb2NhbFN0b3JhZ2UuZ2V0SXRlbShVU0VSX1NUT1JBR0VfSVRFTV9LRVkpKTtcbiAgICBpZiAoY3VycmVudFVzZXIgJiYgdGhpcy50b2tlbkV4cGlyeURhdGVUaW1lclN1YnNjcmlwdGlvbiA9PSBudWxsKSB7XG4gICAgICB0aGlzLnJlZnJlc2hUb2tlblRpbWVyKCk7XG4gICAgfVxuXG4gICAgcmVxdWVzdCA9IHJlcXVlc3QuY2xvbmUoe2hlYWRlcnN9KTtcblxuICAgIGNvbnN0IHN0YXJ0ZWQgPSBEYXRlLm5vdygpO1xuICAgIHJldHVybiBuZXh0LmhhbmRsZShyZXF1ZXN0KS5waXBlKFxuICAgICAgbWFwKGV2ZW50ID0+IHtcbiAgICAgICAgaWYgKGV2ZW50IGluc3RhbmNlb2YgSHR0cFJlc3BvbnNlKSB7XG4gICAgICAgICAgaWYgKCF0aGlzLmVudmlyb25tZW50LnByb2R1Y3Rpb24pIHtcbiAgICAgICAgICAgIGNvbnN0IGVsYXBzZWQgPSBEYXRlLm5vdygpIC0gc3RhcnRlZDtcbiAgICAgICAgICAgIGNvbnNvbGUubG9nKGBSZXF1ZXN0IGZvciAke3JlcXVlc3QudXJsV2l0aFBhcmFtc30gdG9vayAke2VsYXBzZWR9IG1zLmApO1xuICAgICAgICAgIH1cbiAgICAgICAgICBpZiAodGhpcy5jb29raWVTZXJ2aWNlLmdldChUT0tFTl9FWFBJUllfQ09PS0lFX05BTUUpKSB7XG4gICAgICAgICAgICBjb25zb2xlLmxvZyhgZm91bmQgJHtUT0tFTl9FWFBJUllfQ09PS0lFX05BTUV9IHdpdGggdmFsdWUgWyR7dGhpcy5jb29raWVTZXJ2aWNlLmdldChUT0tFTl9FWFBJUllfQ09PS0lFX05BTUUpfV1gKTtcbiAgICAgICAgICAgIGlmICh0aGlzLnRva2VuRXhwaXJ5RGF0ZVRpbWVyU3Vic2NyaXB0aW9uKSB7XG4gICAgICAgICAgICAgIHRoaXMudG9rZW5FeHBpcnlEYXRlVGltZXJTdWJzY3JpcHRpb24udW5zdWJzY3JpYmUoKTtcbiAgICAgICAgICAgICAgdGhpcy5yZWZyZXNoVG9rZW5UaW1lcigpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gZXZlbnQ7XG4gICAgICB9KVxuICAgICk7XG4gIH1cblxuICByZWZyZXNoVG9rZW5UaW1lcigpIHtcbiAgICBsZXQgaXNQdWJsaWNVcmw6IGJvb2xlYW4gPSBmYWxzZTtcbiAgICB0aGlzLnB1YmxpY1VybFBhdHRlcm5zLmZvckVhY2goKHVybFBhdHRlcm46IHN0cmluZykgPT4ge1xuICAgICAgaXNQdWJsaWNVcmwgPSBpc1B1YmxpY1VybCB8fCB0aGlzLnJvdXRlci51cmwuc3RhcnRzV2l0aCh1cmxQYXR0ZXJuKTtcbiAgICB9KTtcbiAgICBpZiAoaXNQdWJsaWNVcmwgJiYgIXRoaXMucm91dGVyLnVybC5zdGFydHNXaXRoKHRoaXMubG9naW5VcmwpKSB7XG4gICAgICAvLyBkbyBub3RoaW5nXG4gICAgICBsb2cuZGVidWcoJ3NraXBwaW5nIHB1YmxpYyB1cmwuLi4nKTtcbiAgICAgIHJldHVybjtcbiAgICB9XG4gICAgbG9nLmRlYnVnKCdzZWN1cmVkIHVybCwgc2V0dGluZyB0aW1lci4uLicpO1xuICAgIGxldCB0b2tlbkV4cGlyeTogdW5rbm93biA9IHRoaXMuY29va2llU2VydmljZS5nZXQoVE9LRU5fRVhQSVJZX0NPT0tJRV9OQU1FKTtcbiAgICB0aGlzLnRva2VuRXhwaXJ5RGF0ZVRpbWVyU3Vic2NyaXB0aW9uID0gdGltZXIodG9rZW5FeHBpcnkgYXMgbnVtYmVyKS5zdWJzY3JpYmUoKCkgPT4ge1xuICAgICAgbG9jYWxTdG9yYWdlLnJlbW92ZUl0ZW0oVVNFUl9TVE9SQUdFX0lURU1fS0VZKTtcbiAgICAgIHRoaXMuY29va2llU2VydmljZS5kZWxldGUoVE9LRU5fRVhQSVJZX0NPT0tJRV9OQU1FKTtcbiAgICAgIHRoaXMuY29va2llU2VydmljZS5kZWxldGUoVE9LRU5fQ09PS0lFX05BTUUpO1xuICAgICAgdGhpcy5yb3V0ZXIubmF2aWdhdGUoW3RoaXMubG9naW5VcmxdLCB7cmVwbGFjZVVybDogdHJ1ZX0pO1xuICAgIH0pO1xuICB9XG59XG4iXX0=